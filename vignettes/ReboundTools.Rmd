---
title: "ReboundTools"
author: "Matthew Kuperus Heun"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{ReboundTools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  fig.width = 5,
  fig.height = 3,
  fig.align = "center",
  fig.retina = 2
)
```

```{r setup, include = FALSE}
library(dplyr)
library(ReboundTools)
```


## Introduction

`ReboundTools` is an `R` package that provides functions to analyze 
energy rebound,  
the unanticipated reduction 
of the benefits of energy efficiency 
due to behavior change and economy-wide effects.
Many functions perform analysis calculations to move from 
known parameters to rebound estimates.
Other functions create rebound graphs in 
energy, cost, and preference spaces.
The functions in this package were used for the 
analyses and graphs in the paper **********.


## Getting started

The first step is specifying parameters for the energy efficiency upgrade (EEU)
and rebound analysis, 
typically in a spreadsheet.
The path to an example spreadsheet can be found with the function `sample_eeu_data_path()`.
Data can be loaded into a data frame as follows:

```{r}
eeu_data <- sample_eeu_data_path() %>% 
  load_eeu_data()
dplyr::glimpse(eeu_data)
```

Variable names are described by various constants in the package:

```{r}
help("eeu_base_params")
help("key_analysis_vars")
help("rebound_stages")
```

Rows of the EEU spreadsheet should contain the cases to be analyzed.
The example file contains two cases: 
a car and an electric lamp.
Columns of the EEU spreadsheet should contain rebound parameters for each case.
Required columns are shown in the example file and `eeu_data` data frame.

```{r}
colnames(eeu_data)
```

Rows can be used for sensitivity analysis, varying one or many parameters in columns 
for each row of the spreadsheet.


## Performing the analysis

After data are loaded, rebound analyses can be performed.
A rebound analysis consists of calculating all rebound terms and intermediate results, 
once for each row of the EEU data frame.
A convenient function to perform the rebound analysis is `rebound_analysis()`.
Columns for intermediate and final results are added to the right of the data frame.

```{r}
rebound_data <- rebound_analysis(eeu_data)
dplyr::glimpse(rebound_data)
```

Note that `rebound_analysis()` is a convenience function that calls several 
helper functions in turn.
Each helper function calculates rebound parameters after one of the rebound effects.

```{r}
simple <- rebound_analysis(eeu_data)
complicated <- eeu_data %>% 
  calc_orig() %>%    # Calculate all parameters before the emplacement effect
  calc_star() %>%    # Calculate all parameters after the emplacement effect
  calc_hat() %>%     # Calculate all parameters after the substitution effect
  calc_bar() %>%     # Calculate all parameters after the income effect
  calc_tilde() %>%   # Calculate all parameters after the productivity effect
  calc_Deltas() %>%  # Calculate all differences between stages
  calc_rebound()     # Calculate all rebound terms
all(simple == complicated)
```


## Rebound graphs

Rebound path graphs can be created with the `rebound_graphs()` function.
Three rebound path graphs are available:

   * Energy paths,
   * Cost paths, and
   * Preference paths.

### Energy path graph

An energy path graph shows the energy effects of the energy efficiency upgrade
with direct energy consumption on the horizontal axis and
indirect energy consumption on the vertical axis.
Diagonal lines with negative slope indicate lines of constant energy consumption.
The following example illustrates an energy path graph. 

```{r}
sample_eeu_data_path() %>% 
  rebound_graphs(cases = "Car", graph_types = "Energy") +
  ggplot2::theme_classic()
```

### Cost path graph

The cost path graph shows costs for rebound stages. 
Direct costs for the energy service (including substitution and income takebacks)
are shown in the horizontal axis;
capital costs, maintenance and disposal costs, substitution effect savings, and
income effect costs are shown in the vertical axis. 
Diagonal lines with negative slope indicate lines of constant expenditure.
Note that the beginning and end of the cost path graph lie on the same
expenditure line, indicating that all freed cash 
(after the emplacement and substitution effects) 
is re-spent on more of the energy service or more other goods or both.


```{r}
sample_eeu_data_path() %>% 
  rebound_graphs(cases = "Car", graph_types = "Cost") +
  ggplot2::theme_classic()
```

### Preferences path graph

The preferences path graph shows normalized energy service consumption on the horizontal axis
and normalized costs of other goods on the vertical axis
for the substitution and income effects.
Diagonal grid lines with negative slope indicate constant expenditure sum
on the energy service (horizontal axis) and other goods (vertical axis).
The swooping, concave-upward grid lines indicate lines of constant utility, 
called indifference curves.

```{r warning = FALSE, message = FALSE}
sample_eeu_data_path() %>% 
  rebound_graphs(cases = "Car", graph_types = "Preferences") +
  ggplot2::xlim(0.995, 1.06) + 
  ggplot2::ylim(0.995, 1.04) +
  ggplot2::theme_classic()
```


## Arguments to `rebound_graphs()`

Setting `indexed = TRUE` normalizes the rebound data to conditions
before emplacement of the energy efficient device, 
such that the starting point is always (1, 1).

```{r}
sample_eeu_data_path() %>% 
  rebound_graphs(indexed = TRUE, cases = "Car", graph_types = "Energy") +
  ggplot2::theme_classic()
```

The `cases` argument tells which `Case`s should be plotted.
All cases are plotted by default, although the result is rarely pleasing.

```{r}
sample_eeu_data_path() %>% 
    rebound_graphs(cases = c("Car", "Lamp"), 
                   graph_types = "Energy") +
  ggplot2::theme_classic()
```

When the cases are overlapping or very different (as above),
faceting may improve the appearance of the graph.
Indexing may be helpful to achieve a pleasing appearance.

```{r, fig.width=5, fig.height=3, fig.align="center"}
sample_eeu_data_path() %>% 
    rebound_graphs(indexed = TRUE,
                   graph_types = "Energy") +
    ggplot2::facet_wrap(facets = "Case") +
  ggplot2::theme_classic()
```

The `graph_types` argument tells which type of graph should be created. 
`graph_types` can be one of
```{r} 
ReboundTools::graph_types
```
The default is all three graph types.
Again, faceting may be beneficial.

```{r}
sample_eeu_data_path() %>% 
  rebound_graphs(indexed = TRUE, cases = "Car") +
  ggplot2::facet_wrap(facets = "graph_type") +
  ggplot2::xlim(0.5, 1.2) +
  ggplot2::ylim(0.99, 1.08) +
  ggplot2::theme_classic()
```






### Controlling the appearance of graphs




The appearance of graphs is controlled by the `graph_params` argument.
Most parameters are self-explanatory.
For example, `ReboundTools::default_graph_params$dempl_colour` 
gives the colour of the direct emplacement path.
See `r help(default_graph_params)` for parameter meanings. 

```{r}
my_params <- default_graph_params
my_params$dempl_colour <- "darkred"
sample_eeu_data_path() %>% 
  rebound_graphs(indexed = TRUE,
                 graph_types = "Energy", 
                 graph_params = my_params) +
  ggplot2::facet_wrap(facets = "Case") +
  ggplot2::theme_classic()
```